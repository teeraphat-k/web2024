<!DOCTYPE html>
<html lang="th">
  <head>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/react-bootstrap@next/dist/react-bootstrap.min.js"
      crossorigin
    ></script>
  </head>
  <body>
    <div id="myapp" class="container p-4"></div>
    <script type="text/babel">
      const { Button, Alert } = ReactBootstrap;

      // Component Menu
      function Menu(props) {
        const handleSubjectSelect = async (subject) => {
          const file = subject === "math" ? "quiz_math.json" : "quiz_science.json"; 
          try {
            const res = await fetch(file);
            if (!res.ok) throw new Error("File not found");
            const data = await res.json();
            props.app.setState({ qlist: data, status: 1, error: null });
          } catch (error) {
            console.error("Error loading quiz data:", error);
            props.app.setState({ error: "ไม่พบข้อมูลแบบทดสอบ" });
          }
        };

        return (
          <div>
            <Alert variant="info">กรุณาเลือกวิชา</Alert>
            <Button
              variant="primary"
              className="m-2"
              onClick={() => handleSubjectSelect("math")}
            >
              คณิตศาสตร์
            </Button>
            <Button
              variant="success"
              className="m-2"
              onClick={() => handleSubjectSelect("science")}
            >
              วิทยาศาสตร์
            </Button>
            {props.app.state.error && (
              <Alert variant="danger" className="mt-3">
                {props.app.state.error}
              </Alert>
            )}
          </div>
        );
      }

      // Component QList
      function QList(props) {
        const valid = props.app.state.valid;

        return (
          <div>
            <div>
              {props.list.map((q, i) => (
                <div key={i}>
                  <QBlock q={q} i={i} app={props.app} />
                </div>
              ))}
            </div>
            <div>
              {valid ? (
                <Button
                  variant="success"
                  onClick={() => props.app.checkAnswer()}
                >
                  ตรวจคำตอบ
                </Button>
              ) : (
                <span className="text-danger">กรุณาตอบให้ครบ</span>
              )}
            </div>
          </div>
        );
      }

      // Component QBlock
      function QBlock({ i, q, app }) {
        const handleChange = (event) => {
          const name = event.target.name;
          const value = event.target.value;
          const answers = app.state.answers;
          answers[name] = value;
          app.setState({ answers });
          app.validate();
        };

        return (
          <div>
            <div>
              {i + 1}. {q.title}
            </div>
            <div>
              {q.options.map((p, pi) => (
                <div key={pi}>
                  <label>
                    <input
                      type="radio"
                      name={"q" + i}
                      value={pi + 1}
                      onChange={handleChange}
                    />{" "}
                    {p}
                  </label>
                </div>
              ))}
            </div>
          </div>
        );
      }

      // Component ShowScore
      function ShowScore({ app }) {
        return (
          <div className="p-2">
            <h3>
              คุณได้คะแนน {app.state.score} / {app.state.qlist.length}
            </h3>
            <Button
              variant="primary"
              onClick={() =>
                app.setState({ status: 0, answers: {}, score: 0, valid: false })
              }
            >
              ตกลง
            </Button>
          </div>
        );
      }

      // Main Component App
      class App extends React.Component {
        state = {
          qlist: [], 
          status: 0, 
          answers: {}, 
          score: 0, 
          valid: false,
          error: null,
        };

        // ตรวจคำตอบและคำนวณคะแนน
        checkAnswer() {
          const score = this.state.qlist.reduce((total, q, i) => {
            return total + (q.answer === parseInt(this.state.answers["q" + i]) ? 1 : 0);
          }, 0);
          this.setState({ status: 2, score });
        }

        // ตรวจสอบว่าตอบครบทุกข้อหรือยัง
        validate() {
          const valid = this.state.qlist.every((q, i) =>
            this.state.answers["q" + i]
          );
          this.setState({ valid });
        }

        render() {
          let content;
          if (this.state.status === 0) {
            content = <Menu app={this} />;
          } else if (this.state.status === 1) {
            content = <QList list={this.state.qlist} app={this} />;
          } else if (this.state.status === 2) {
            content = <ShowScore app={this} />;
          }

          return (
            <div className="card">
              <div className="card-header">แบบทดสอบด้วย ReactJS</div>
              <div className="card-body">{content}</div>
              <div className="card-footer">
                College of Computing, Khon Kaen University
              </div>
            </div>
          );
        }
      }

      const container = document.getElementById("myapp");
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
  </body>
</html>
